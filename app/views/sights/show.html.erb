<% content_for :css do %>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
    <%= stylesheet_link_tag("sight") %>
<% end %>

<% content_for :javascript do %>
    <%= javascript_include_tag("https://maps-api-ssl.google.com/maps/api/js?sensor=false") %>
<% end %>

<% content_for :body do %>

    <script type="text/javascript">
        var lastOpened = null; // the last opened infowindow
		
		/*
		// to preload images in infowindows
		function swapsource_and_dosomething(url,handler,element){
		  var img=new Image();
		  img.onload=function(){
		    element.src= url;
		    return handler(element);
		  }
		  img.src=url;
		}
		*/
	
        // adds photo markers to the map
        function add_marker(map, lat, lng, cent, contentString) { 
          var latlng = new google.maps.LatLng(lat, lng);

          var marker = new google.maps.Marker({
              position: latlng,
              map: map
          });
          marker.infowindow = new google.maps.InfoWindow({
            content: contentString,
          });

          // pops up an infowindow when you click on a marker
          google.maps.event.addListener(marker, 'click', function() {
              if(lastOpened != null) lastOpened.infowindow.close();
              marker.infowindow.open(map,marker);
              lastOpened = marker;
          });
          // recenters map when you close an infowindow
          google.maps.event.addListener(marker.infowindow,'closeclick', function() {
              map.setCenter(cent);
              lastOpened = null;
          });
        }

        $(document).ready(function() {
            var cent = new google.maps.LatLng(<%= @sight.latitude %>, <%= @sight.longitude %>);
            var map = new google.maps.Map(document.getElementById("map-canvas"), {
                zoom: 16,
                center: cent,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            var circle = new google.maps.Circle({
                radius: <%= @sight.radius %>,
                center: cent,
                map: map,
                strokeWeight: 1
            });
            var contentString;

			<% @sight.photos.each do |photo| %>
				$.getJSON("/photos/"+<%= photo.id %>, function(json) {

				var contentString = "<b>Photo "+json.id+"</b>" +
					"<div id= 'infoWindowDiv'>" +
						"<a href=/photos/"+json.id+">";
							if (json.thumbnail != null) {
								contentString += "<img src="+json.thumbnail+">";
							} else {
								contentString += "Photo Unavailable";
							} contentString +=
						"</a>" +
					"</div>"; 
				add_marker(map, json.latitude, json.longitude, cent, contentString);
				});
			<% end %>
        });
    </script>   
	
	<div id="content">
        <div id="map-canvas"></div>
      
		<div id="sight-info">
            
            <div id="sight-tags">
                Tags:
                <% @sight.tags.each do |tag| %>
                    <%= link_to(tag.tag, tag_path(tag)) %>
                <% end %>
                <%= render 'tags/form' %>
            </div>
        </div>
		<div id="comment-container">
            <div id="comment-box">
                <%= render 'comments/form' %>
            </div>
            <div id="comment-list">
                <% @sight.comments.each do |comment| %>
                    <div class="comment">
                        <%= comment.comment %>
                        <br>
                            <%= link_to(comment.user.user_name, user_path(comment.user)) %> on <%= comment.date %> at <%= comment.time %>
                        <br>
                    </div>
                <% end %>
            </div>
		</div>
	</div>

<% end %>
