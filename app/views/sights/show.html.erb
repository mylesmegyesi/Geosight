<% content_for :css do %>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
    <%= stylesheet_link_tag("map") %>
<% end %>

<% content_for :javascript do %>
    <%= javascript_include_tag("https://maps.google.com/maps/api/js?sensor=false") %>
<% end %>

<% content_for :body do %>

    <script type="text/javascript">
        var lastOpened = null; // the last opened infowindow
        // adds photo markers to the map
        function add_marker(map, bounds, lat, lng, i, cent, contentString) { 
          var latlng = new google.maps.LatLng(lat, lng);

          bounds.extend(latlng);

          var marker = new google.maps.Marker({
              position: latlng,
              title:'Photo '+i, map: map
          });
          marker.infowindow = new google.maps.InfoWindow({
            content: contentString 
          });

          // pops up an infowindow when you click on a marker
          google.maps.event.addListener(marker, 'click', function() {
              if(lastOpened != null) lastOpened.infowindow.close();
              marker.infowindow.open(map,marker);
              lastOpened = marker;
          });
          // recenters map when you close an infowindow
          google.maps.event.addListener(marker.infowindow,'closeclick', function() {
              map.setCenter(cent);
              lastOpened = null;
          });
        }

        $(document).ready(function() {
            var bounds = new google.maps.LatLngBounds ();
            var cent = new google.maps.LatLng(<%= @sight.latitude %>, <%= @sight.longitude %>);
            var myOptions = { zoom: 19, center: cent, mapTypeId: google.maps.MapTypeId.HYBRID };
            var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            var circle = new google.maps.Circle({
                radius: <%= @sight.radius %>, center: cent, map: map, strokeWeight: 1
            });
            var contentString = null;
            <% @sight.photos.each_with_index do |photo, i| %>
              contentString = 
              '<b>Photo <%= i+1 %></b>'+
              '<div id="infoWindowDiv">'+
                '<%= link_to image_tag(photo.file.url(:thumb)), photo_path(photo) %>'+
                'Tags: '+
                <% first = true %>
                <% photo.tags.collect do |ptag| %>
                  <% if first == false %>
                      '<%= ", " %>'+
                  <% else %>
                      <% first = false %>
                  <% end %>
                  '<%= link_to(ptag.tag, tag_path(ptag)) %>'+
                <% end %>
              '</div>';
              add_marker( map, bounds,
                <%= photo.latitude %>, <%= photo.longitude %>,
                <%= i+1 %>, cent, contentString);
            <% end%>
        });
    </script>
    
    <div id="map_canvas"></div>
    
    <p>
        <b>Latitude:</b>
        <%= @sight.latitude %>
    </p>
    
    <p>
        <b>Longitude:</b>
        <%= @sight.longitude %>
    </p>
    
    <p>
        <b>Name:</b>
        <%= @sight.name %>
    </p>
    
    <p>
        <b>Radius:</b>
        <%= @sight.radius %>
    </p>
    
    <%= link_to 'Photos', photos_path({:sight_id => @sight.id}) %> |
    <%= link_to 'Back to Sights', sights_path %>

<% end %>
